var validArgs=function(){for(var t=[],e=PPx.Arguments;!e.atEnd();e.moveNext())t.push(e.value);return t},t={tempKey:"K_ppmTemp",tempMenu:"M_ppmTemp",lfDset:"ppm_lfdset",virtualEntry:"ppm_ve"},e={storeData:8e4,veHandler:80001,setsel:80002,stackPPb:80003},n=PPx.CreateObject("Scripting.FileSystemObject"),isEmptyStr=function(t){return""===t};Array.prototype.indexOf||(Array.prototype.indexOf=function(t,e){var n;if(null==this)throw new Error('Array.indexOf: "this" is null or not defined');var a=Object(this),r=a.length>>>0;if(0===r)return-1;var p=null!=e?e:0;if(Math.abs(p)===Infinity&&(p=0),p>=r)return-1;for(n=Math.max(p>=0?p:r-Math.abs(p),0);n<r;){if(n in a&&a[n]===t)return n;n++}return-1});var a=["KC_main","KV_main","KV_img","KV_crt","KV_page","KB_edit","K_ppe","K_edit"],_validTable=function(t){return~a.indexOf(t)?t:"KC_main"},discard=function(t){return function(e){var n=e.table,a=e.label,r=e.mapkey,p=e.cond,i=void 0===p?"instantly":p,c=e.debug,u=void 0===c?"0":c,x=PPx.StayMode,s=PPx.Extract("%n"),P=PPx.Extract("%FDV"),o="*linecust "+a+s+","+_validTable(n)+":"+t+",",d={instantly:"",once:'*if("'+s+'"=="%n")%:',hold:'*if("'+s+'"=="%n")&&("'+P+'"!="%FDV")%:'}[i],l=[o];r&&(PPx.Execute("*mapkey use,"+r),l.push("*mapkey delete,"+r)),l.push('*js ":'+x+',ppx_Discard",'+u+","+a),PPx.Execute(o+"%(*if %*stayinfo("+x+")%:"+d+l.join("%:")+"%)"),PPx.Execute('*run -nostartmsg %0pptrayw.exe -c %%K"@LOADCUST"')}},ppx_Discard=function(t,e){var n;PPx.StayMode=0,e=null!=(n=e)?n:"","DEBUG"===t&&PPx.linemessage("[DEBUG] discard "+e)},r=(discard("ACTIVEEVENT"),{hold:function(t,e){void 0===e&&(e="0");var n=PPx.StayMode;_setEvent("KC_main","LOADEVENT",t+"%n",'*script ":'+n+',ppx_Discard",'+e+","+t,"hold")},discard:discard("LOADEVENT")}),_setEvent=function(t,e,n,a,r){var p="*linecust "+n+","+_validTable(t),i=p+":"+e+",",c={instantly:"",once:'*if("%n"=="%%n")',hold:'*if("%n"=="%%n")&&("%FDV"=="%%FDV")'}[r];PPx.Execute(p+":"+e+","+c+"%%:"+i+"%%:"+a),PPx.Execute('%K"@LOADCUST"')},waitMoment=function(t){for(var e=10;t()&&(PPx.Sleep(100),!(0>=--e)););},p=e.veHandler,i=t.virtualEntry,c="S_ppm#actions",u="@#_#@",x={metadata:{},ppv:{}},main=function(){var t=validArgs(),e=t[0],n=t[1],a=t[2],c=t[3],u=t[4],s=t[5];"undefined"!==c&&(PPx.StayMode=p,x.metadata=_convMetadata(e,n,a,c,u,s),r.discard({table:"KC_main",label:i,mapkey:u,cond:"hold"}))},_convMetadata=function(t,e,n,a,r,p){var conv=function(t){return"undefined"!==t?t:""};return{base:conv(t),dirtype:conv(e),search:conv(n),ppm:a,mapkey:conv(r),freq:conv(p)}},ppx_Action=function(t,e,a){var r=escapedCmdline(x.metadata.ppm,t);isEmptyStr(r)&&PPx.Quit(1);var p,i="every"===x.metadata.freq,c=i?function(t){var e=t.entry,n=t.isDup,a=replaceCmdline({cmdline:r,base:x.metadata.base,dirtype:x.metadata.dirtype,search:x.metadata.search,isDup:n,entry:e});PPx.Execute("%OP- *execute ,%("+a+"%)")}:function(t){var e=t.entry;P.push(e.path)},s=blankHandle(e),P=[],o={},d=PPx.Entry;d.FirstMark;do{var l={att:d.Attributes,hl:d.Highlight,path:~d.Comment.indexOf(":")?d.Comment:x.metadata.base+"\\"+d.Comment,sname:d.ShortName};n.FileExists(l.path)&&(~l.path.indexOf(" ")&&(l.path=s(l.path)),p=o[l.path]||"0",(a||"0"===p)&&(o[l.path]="1",c({entry:l,isDup:p})))}while(d.NextMark);if(!i){var m="dup:0"+u+"search:"+x.metadata.search+u+"path:"+P.join(" "),v="^dup:(?<dup>0)"+u+"search:(?<search>.*)"+u+"path:(?<path>.+)$";PPx.Execute('%OP *execute ,%%OP- %*regexp("%('+m+'%)","%(/'+v+"/"+r+'/%)")')}},escapedCmdline=function(t,e){return(PPx.Extract("%*getcust("+c+":"+t+"_"+e+")")||PPx.Extract("%*getcust("+c+":all_"+e+")")).replace(/\//g,"\\/")},blankHandle=function(t){var e={enclose:function(t){return'"'+t+'"'},double:function(t){return'""'+t+'""'},escape:function(t){return t.replace(/\s/g,"\\ ")}},n=e[t];return null!=n?n:e.enclose},replaceCmdline=function(t){var e,n,a=t.cmdline,r=t.base,p=t.dirtype,i=t.search,c=t.isDup,x=t.entry,s=null!=(e=x.att)?e:"",P=x.hl?String(x.hl):"",o=null!=(n=x.sname)?n:"",d="base:"+r+u+"dirtype:"+p+u+"search:"+i+u+"dup:"+c+u+"path:"+x.path+u+"att:"+s+u+"hl:"+P+u+"option:"+o,l="base:(?<base>.*)"+u+"dirtype:(?<type>.*)"+u+"search:(?<search>.*)"+u+"dup:(?<dup>.+)"+u+"path:(?<path>.+)"+u+"att:(?<att>.*)"+u+"hl:(?<hl>.*)"+u+"option:(?<option>.*)";return PPx.Extract('%OP %*regexp("%('+d+'%)","%(/'+l+"/"+a+'/%)")')},ppx_Syncview=function(t,e,n,a,r){x.ppv.id?isEmptyStr(PPx.Extract("%N"+x.ppv.id))||(PPx.SyncView=0,PPx.Execute(_selectevent("")+"%:"+_activeevent("")),"1"===e&&PPx.Execute("*closeppx "+x.ppv.id),PPx.Execute("*setcust XV_lnum="+x.ppv.lnum+"%:*setcust XV_tmod="+x.ppv.tmod),"0"!==n&&(PPx.Execute("*setcust _WinPos:"+x.ppv.id+"="+x.ppv.winpos),"2"===n&&PPx.Execute("*setcust X_win:V="+x.ppv.xwin)),x.ppv={}):(startPPv(t,n,a,r),PPx.Execute(_selectevent("*if %*stayinfo("+p+')&&("%n"=="%%n")&&("%FDV"=="%%FDV")%%:*script ":'+p+',ppx_SelectEvent",'+r)),PPx.Execute(_activeevent('*if ("%%N%n"=="")%%:'+_selectevent("")+"%%:"+_activeevent(""))),ppx_SelectEvent(r))},ppx_SelectEvent=function(t){var e=PPx.Extract('%*name(DC,"%*comment")');if("1"===t){var n=PPx.Extract('%*name(SC,"%FSC")');"-"!==n&&(e!==PPx.Extract("%*extract("+x.ppv.id+',"%%FDC")')&&(PPx.Execute("*execute "+x.ppv.id+',%%J"'+e+'"'),waitMoment((function(){return PPx.Extract("%*extract("+x.ppv.id+',"%%FDC")')!==e}))),PPx.Execute("*execute "+x.ppv.id+",*jumpline "+n))}else PPx.Execute("*execute "+x.ppv.id+',%%J"'+e+'"')},_selectevent=function(t){return"*linecust "+i+",KC_main:SELECTEVENT,"+t},_activeevent=function(t){return"*linecust "+i+",KC_main:ACTIVEEVENT,"+t},startPPv=function(t,e,n,a){var r=PPx.Pane.Count>1,p=!isEmptyStr(t);"0"!==e&&r&&(p&&!isEmptyStr(PPx.Extract("%NV"+t))&&PPx.Execute("*closeppx V"+t),x.ppv.winpos=PPx.Extract("%*getcust(_WinPos:V"+t+")"),"2"===e&&(x.ppv.xwin=PPx.Extract("%*getcust(X_win:V)"),PPx.Execute("*setcust X_win:V=B1"+x.ppv.xwin.slice(2))));var i="";p&&(i="-bootid:"+t,i="1"===e?i+" -popup:%~N":"");var c,u="*topmostwindow %N,1";("1"!==n||isEmptyStr(x.metadata.search)||(u=u+'%:*find "'+x.metadata.search+'"'),"1"===a&&(x.ppv.lnum=PPx.Extract("%*getcust(XV_lnum)"),x.ppv.tmod=PPx.Extract("%*getcust(XV_tmod)"),PPx.Execute("*setcust XV_lnum=1%:*setcust XV_tmod=1")),x.ppv.id=PPx.Extract("%Oai *ppv "+i+" -k %("+u+'%)%%:*focus %n%:%*extract(V,"%%n")'),"2"===e&&r)&&(x.ppv.winpos=null!=(c=x.ppv.winpos)?c:PPx.Extract("%*getcust(_WinPos:"+x.ppv.id+")"),PPx.Execute("*capturewindow "+x.ppv.id+" -pane:~ -selectnoactive"))};main();export{blankHandle,replaceCmdline};
