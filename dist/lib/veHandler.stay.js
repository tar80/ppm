var validArgs=function(){for(var t=[],e=PPx.Arguments;!e.atEnd();e.moveNext())t.push(e.value);return t},t={actions:"S_ppm#actions",event:"S_ppm#event",global:"S_ppm#global",sources:"S_ppm#sources",staymode:"S_ppm#staymode",user:"S_ppm#user"},e={tempKey:"K_ppmTemp",tempMenu:"M_ppmTemp",lfDset:"ppm_lfdset",virtualEntry:"ppm_ve"},n={storeData:8e4,veHandler:80001,setsel:80002,stackPPb:80003},a=PPx.CreateObject("Scripting.FileSystemObject"),isEmptyStr=function(t){return""===t},capturePPv=function(t,e,n){!e&&PPx.Execute("*launch -nostartmsg -hide -wait:idle %0ppvw.exe -bootid:"+t),PPx.Execute("*capturewindow V"+t+" -pane:~ -selectnoactive%:*wait 0,2"),n&&PPx.Execute("*ppvoption sync "+t)};Array.prototype.indexOf||(Array.prototype.indexOf=function(t,e){var n;if(null==this)throw new Error('Array.indexOf: "this" is null or not defined');var a=Object(this),i=a.length>>>0;if(0===i)return-1;var r=null!=e?e:0;if(Math.abs(r)===Infinity&&(r=0),r>=i)return-1;for(n=Math.max(r>=0?r:i-Math.abs(r),0);n<i;){if(n in a&&a[n]===t)return n;n++}return-1});var ppx_Discard=function(t,e){var n;PPx.StayMode=0,e=null!=(n=e)?n:"","DEBUG"===t&&PPx.linemessage("[DEBUG] discard "+e)},i=["KC_main","KV_main","KV_img","KV_crt","KV_page","KB_edit","K_ppe","K_edit","K_lied"],_validTable=function(t){return~i.indexOf(t)?t:"KC_main"},_linecust=function(t,e,n){return"*linecust "+t+","+e+":"+n+","},_discard=function(t){return function(e){var n=e.table,a=e.label,i=e.mapkey,r=e.cond,p=void 0===r?"instantly":r,u=e.debug,c=void 0===u?"0":u,s=PPx.StayMode,o=PPx.Extract("%n"),x=PPx.Extract('%*name(C,"%FDV")'),d=_validTable(n),P=_linecust(""+a+o,d,t),l=_linecust(""+a+o,d,"CLOSEEVENT"),m={instantly:"",once:'*if("'+o+'"=="%n")%:',hold:'*if("'+o+'"=="%n")&&("'+x+'"!="%*name(C,"%FDV")")%:'},v=[P,l];i&&(PPx.Execute("*mapkey use,"+i),v.push("*mapkey delete,"+i)),v.push('*js ":'+s+',ppx_Discard",'+c+","+a),PPx.Execute(P+"%(*if %*stayinfo("+s+")%:"+m[p]+v.join("%:")+"%)"),PPx.Execute(l+"%("+m.once+l+"%:"+P+"%)"),PPx.Execute('*launch -breakjob -nostartmsg -wait:no %0pptrayw.exe -c %%K"@LOADCUST"')}},getStaymodeId=function(t){t=~t.indexOf(".")?t.slice(0,t.indexOf(".")):t;var e=Number(PPx.Extract("%*getcust(S_ppm#staymode:"+t+")"));return!isNaN(e)&&e>1e4&&e},r=(_discard("ACTIVEEVENT"),{hold:function(t,e){void 0===e&&(e="0");var n=PPx.StayMode;_setEvent("KC_main","LOADEVENT",t+"%n",'*script ":'+n+',ppx_Discard",'+e+","+t,"hold")},discard:_discard("LOADEVENT")}),_setEvent=function(t,e,n,a,i){var r="*linecust "+n+","+_validTable(t),p=r+":"+e+",",u={instantly:"",once:'*if("%n"=="%%n")',hold:'*if("%n"=="%%n")&&("%FDV"=="%%FDV")'}[i];PPx.Execute(r+":"+e+","+u+"%%:"+p+"%%:"+a),PPx.Execute('%K"@LOADCUST"')},waitMoment=function(t){for(var e=10;t()&&(PPx.Sleep(100),!(0>=--e)););},p=getStaymodeId("veHandler")||n.veHandler,u="restorePPv.js",c=e.virtualEntry,s=t.actions,o="@#_#@",cache={metadata:{},ppv:{}};PPx.StayMode=p;var main=function(){var t=validArgs(),e=t[0],n=t[1],a=t[2],i=t[3],p=t[4],u=t[5];"undefined"!==i&&(cache.metadata=convMetadata(e,n,a,i,p,u),r.discard({table:"KC_main",label:c,mapkey:cache.metadata.mapkey,cond:"hold"}))},ppx_resume=function(){},ppx_Action=function(t,e,n){var i=escapedCmdline(cache.metadata.ppm,t);isEmptyStr(i)&&PPx.Quit(1);var r,p="every"===cache.metadata.freq,u=p?function(t){var e=t.entry,n=t.isDup,a=replaceCmdline({cmdline:i,base:cache.metadata.base,dirtype:cache.metadata.dirtype,search:cache.metadata.search,isDup:n,entry:e});PPx.Execute("%OP- *execute ,%("+a+"%)")}:function(t){var e=t.entry;s.push(e.path)},c=blankHandle(e),s=[],x={},d=PPx.Entry;d.FirstMark;do{var P={att:d.Attributes,hl:d.Highlight,path:~d.Comment.indexOf(":")?d.Comment:cache.metadata.base+"\\"+d.Comment,sname:d.ShortName};a.FileExists(P.path)&&(~P.path.indexOf(" ")&&(P.path=c(P.path)),r=x[P.path]||"0",(n||"0"===r)&&(x[P.path]="1",u({entry:P,isDup:r})))}while(d.NextMark);if(!p){var l="dup:0"+o+"search:"+cache.metadata.search+o+"path:"+s.join(" "),m="^dup:(?<dup>0)"+o+"search:(?<search>.*)"+o+"path:(?<path>.+)$";PPx.Execute('%OP *execute ,%%OP- %*regexp("%('+l+'%)","%(/'+m+"/"+i+'/%)")')}},ppx_Syncview=function(t,e,n,a,i){var r="1"===e;if(cache.ppv.id)isEmptyStr(PPx.Extract("%N"+cache.ppv.id))||(PPx.Execute(_selectEvent("")),r?(PPx.Execute("*closeppx "+cache.ppv.id),cache.ppv={}):cache.ppv.id=undefined);else{if(cache.ppv.id=startPPv(t,n,a,i),isEmptyStr(cache.ppv.id))return void PPx.linemessage('!"could not get PPv ID');PPx.Execute(_selectEvent("*if %*stayinfo("+p+')&&("%n"=="%%n")&&("%FDV"=="%%FDV")%%:*js ":'+p+',ppx_SelectEvent",'+i)),PPx.Execute(_closeEvent(cache.ppv.id.slice(-1))),ppx_SelectEvent(i)}},ppx_SelectEvent=function(t){var e=PPx.Extract('%*name(DC,"%*comment")');if("1"===t){var n=PPx.Extract('%*name(SCN,"%FSCN")');"-"!==n&&(e!==PPx.Extract("%*extract("+cache.ppv.id+',"%%FDC")')&&(PPx.Execute("*execute "+cache.ppv.id+',%%J"'+e+'"'),waitMoment((function(){return PPx.Extract("%*extract("+cache.ppv.id+',"%%FDC")')!==e}))),PPx.Execute("*execute "+cache.ppv.id+",*jumpline "+n))}else PPx.Execute("*execute "+cache.ppv.id+',%%J"'+e+'"')},convMetadata=function(t,e,n,a,i,r){var conv=function(t){return"undefined"!==t?t:""};return{base:conv(t),dirtype:conv(e),search:conv(n),ppm:a,mapkey:conv(i),freq:conv(r)}},escapedCmdline=function(t,e){return(PPx.Extract("%*getcust("+s+":"+t+"_"+e+")")||PPx.Extract("%*getcust("+s+":all_"+e+")")).replace(/\//g,"\\/")},blankHandle=function(t){var e={enclose:function(t){return'"'+t+'"'},double:function(t){return'""'+t+'""'},escape:function(t){return t.replace(/\s/g,"\\ ")}},n=e[t];return null!=n?n:e.enclose},replaceCmdline=function(t){var e,n,a=t.cmdline,i=t.base,r=t.dirtype,p=t.search,u=t.isDup,c=t.entry,s=null!=(e=c.att)?e:"",x=c.hl?String(c.hl):"",d=null!=(n=c.sname)?n:"",P="base:"+i+o+"dirtype:"+r+o+"search:"+p+o+"dup:"+u+o+"path:"+c.path+o+"att:"+s+o+"hl:"+x+o+"option:"+d,l="base:(?<base>.*)"+o+"dirtype:(?<type>.*)"+o+"search:(?<search>.*)"+o+"dup:(?<dup>.+)"+o+"path:(?<path>.+)"+o+"att:(?<att>.*)"+o+"hl:(?<hl>.*)"+o+"option:(?<option>.*)";return PPx.Extract('%OP %*regexp("%('+P+'%)","%(/'+l+"/"+a+'/%)")')},_selectEvent=function(t){return"*linecust "+c+",KC_main:SELECTEVENT,"+t},_closeEvent=function(t){var e="*linecust "+c+",KV_main:CLOSEEVENT,",n=[];if(cache.ppv.lnum&&n.push("*setcust XV_lnum="+cache.ppv.lnum),cache.ppv.tmod&&n.push("*setcust XV_tmod="+cache.ppv.tmod),cache.ppv.xwin&&n.push("*setcust X_win:V="+cache.ppv.xwin),cache.ppv.winpos){var a="-nostartmsg -hide -noppb",i="*script "+("%sgu'ppmlib'\\"+u)+',"'+t+'","'+cache.ppv.winpos+'","DEBUG"';n.push("%Oq *launch "+a+" %0ppbw.exe -c "+i)}return e+'%(*if("V'+t+'"=="%n")%:'+e+"%:"+_selectEvent("")+"%:"+n.join("%:")+"%)"},startPPv=function(t,e,n,a){var i=!isEmptyStr(t),r=2===PPx.Pane.Count,p=["*topmostwindow %N,1"];"1"!==n||isEmptyStr(cache.metadata.search)||p.push('*find "'+cache.metadata.search+'"'),"1"===a&&(cache.ppv.lnum=PPx.Extract("%*getcust(XV_lnum)"),cache.ppv.tmod=PPx.Extract("%*getcust(XV_tmod)"),PPx.Execute("*setcust XV_lnum=1%:*setcust XV_tmod=1"));var u,c=[];if(i?(c.push("-bootid:"+t+" -r"),u="%:V"+t):u='%:%*extract(V,"%%n")',"0"!==e&&r){if(cache.ppv.winpos=PPx.Extract("%*getcust(_WinPos:V"+t+")"),"2"===e){cache.ppv.xwin=PPx.Extract("%*getcust(X_win:V)"),PPx.Execute("*setcust X_win:V=B1"+cache.ppv.xwin.slice(2));var s=PPx.Extract("*launch -nostartmsg -hide -wait:idle %0ppvw.exe "+c.join(" ")+u);return capturePPv(s.slice(-1),!0,!1),s}c.push("-popup:%~N")}return PPx.Extract("*launch -nostartmsg -wait:idle %0ppvw.exe "+c.join(" ")+" -k %("+p.join("%:")+"%)%%:*focus %n"+u)};main();
