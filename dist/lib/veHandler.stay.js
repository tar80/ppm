var validArgs=function(){for(var t=[],e=PPx.Arguments;!e.atEnd();e.moveNext())t.push(e.value);return t},t={actions:"S_ppm#actions",event:"S_ppm#event",global:"S_ppm#global",sources:"S_ppm#sources",staymode:"S_ppm#staymode",user:"S_ppm#user"},e={tempKey:"K_ppmTemp",tempMenu:"M_ppmTemp",lfDset:"ppm_lfdset",virtualEntry:"ppm_ve"},n={storeData:8e4,veHandler:80001,setsel:80002,stackPPb:80003},a=PPx.CreateObject("Scripting.FileSystemObject"),isEmptyStr=function(t){return""===t};Array.prototype.indexOf||(Array.prototype.indexOf=function(t,e){var n;if(null==this)throw new Error('Array.indexOf: "this" is null or not defined');var a=Object(this),r=a.length>>>0;if(0===r)return-1;var p=null!=e?e:0;if(Math.abs(p)===Infinity&&(p=0),p>=r)return-1;for(n=Math.max(p>=0?p:r-Math.abs(p),0);n<r;){if(n in a&&a[n]===t)return n;n++}return-1});var r=["KC_main","KV_main","KV_img","KV_crt","KV_page","KB_edit","K_ppe","K_edit"],_validTable=function(t){return~r.indexOf(t)?t:"KC_main"},_discard=function(t){return function(e){var n=e.table,a=e.label,r=e.mapkey,p=e.cond,i=void 0===p?"instantly":p,c=e.debug,u=void 0===c?"0":c,s=PPx.StayMode,x=PPx.Extract("%n"),o=PPx.Extract("%FDV"),P="*linecust "+a+x+","+_validTable(n)+":"+t+",",d={instantly:"",once:'*if("'+x+'"=="%n")%:',hold:'*if("'+x+'"=="%n")&&("'+o+'"!="%FDV")%:'}[i],l=[P];r&&(PPx.Execute("*mapkey use,"+r),l.push("*mapkey delete,"+r)),l.push('*js ":'+s+',ppx_Discard",'+u+","+a),PPx.Execute(P+"%(*if %*stayinfo("+s+")%:"+d+l.join("%:")+"%)"),PPx.Execute('*run -nostartmsg %0pptrayw.exe -c %%K"@LOADCUST"')}},getStaymodeId=function(t){var e=Number(PPx.Extract("%*getcust(S_ppm#staymode:"+t+")"));return!Number.isNaN(e)&&e>1e4&&e},ppx_Discard=function(t,e){var n;PPx.StayMode=0,e=null!=(n=e)?n:"","DEBUG"===t&&PPx.linemessage("[DEBUG] discard "+e)},p=(_discard("ACTIVEEVENT"),{hold:function(t,e){void 0===e&&(e="0");var n=PPx.StayMode;_setEvent("KC_main","LOADEVENT",t+"%n",'*script ":'+n+',ppx_Discard",'+e+","+t,"hold")},discard:_discard("LOADEVENT")}),_setEvent=function(t,e,n,a,r){var p="*linecust "+n+","+_validTable(t),i=p+":"+e+",",c={instantly:"",once:'*if("%n"=="%%n")',hold:'*if("%n"=="%%n")&&("%FDV"=="%%FDV")'}[r];PPx.Execute(p+":"+e+","+c+"%%:"+i+"%%:"+a),PPx.Execute('%K"@LOADCUST"')},waitMoment=function(t){for(var e=10;t()&&(PPx.Sleep(100),!(0>=--e)););},i=getStaymodeId("veHandler")||n.veHandler,c=e.virtualEntry,u=t.actions,s="@#_#@",x={metadata:{},ppv:{}},main=function(){var t=validArgs(),e=t[0],n=t[1],a=t[2],r=t[3],u=t[4],s=t[5];"undefined"!==r&&(PPx.StayMode=i,x.metadata=_convMetadata(e,n,a,r,u,s),p.discard({table:"KC_main",label:c,mapkey:u,cond:"hold"}))},_convMetadata=function(t,e,n,a,r,p){var conv=function(t){return"undefined"!==t?t:""};return{base:conv(t),dirtype:conv(e),search:conv(n),ppm:a,mapkey:conv(r),freq:conv(p)}},ppx_Action=function(t,e,n){var r=escapedCmdline(x.metadata.ppm,t);isEmptyStr(r)&&PPx.Quit(1);var p,i="every"===x.metadata.freq,c=i?function(t){var e=t.entry,n=t.isDup,a=replaceCmdline({cmdline:r,base:x.metadata.base,dirtype:x.metadata.dirtype,search:x.metadata.search,isDup:n,entry:e});PPx.Execute("%OP- *execute ,%("+a+"%)")}:function(t){var e=t.entry;o.push(e.path)},u=blankHandle(e),o=[],P={},d=PPx.Entry;d.FirstMark;do{var l={att:d.Attributes,hl:d.Highlight,path:~d.Comment.indexOf(":")?d.Comment:x.metadata.base+"\\"+d.Comment,sname:d.ShortName};a.FileExists(l.path)&&(~l.path.indexOf(" ")&&(l.path=u(l.path)),p=P[l.path]||"0",(n||"0"===p)&&(P[l.path]="1",c({entry:l,isDup:p})))}while(d.NextMark);if(!i){var m="dup:0"+s+"search:"+x.metadata.search+s+"path:"+o.join(" "),v="^dup:(?<dup>0)"+s+"search:(?<search>.*)"+s+"path:(?<path>.+)$";PPx.Execute('%OP *execute ,%%OP- %*regexp("%('+m+'%)","%(/'+v+"/"+r+'/%)")')}},escapedCmdline=function(t,e){return(PPx.Extract("%*getcust("+u+":"+t+"_"+e+")")||PPx.Extract("%*getcust("+u+":all_"+e+")")).replace(/\//g,"\\/")},blankHandle=function(t){var e={enclose:function(t){return'"'+t+'"'},double:function(t){return'""'+t+'""'},escape:function(t){return t.replace(/\s/g,"\\ ")}},n=e[t];return null!=n?n:e.enclose},replaceCmdline=function(t){var e,n,a=t.cmdline,r=t.base,p=t.dirtype,i=t.search,c=t.isDup,u=t.entry,x=null!=(e=u.att)?e:"",o=u.hl?String(u.hl):"",P=null!=(n=u.sname)?n:"",d="base:"+r+s+"dirtype:"+p+s+"search:"+i+s+"dup:"+c+s+"path:"+u.path+s+"att:"+x+s+"hl:"+o+s+"option:"+P,l="base:(?<base>.*)"+s+"dirtype:(?<type>.*)"+s+"search:(?<search>.*)"+s+"dup:(?<dup>.+)"+s+"path:(?<path>.+)"+s+"att:(?<att>.*)"+s+"hl:(?<hl>.*)"+s+"option:(?<option>.*)";return PPx.Extract('%OP %*regexp("%('+d+'%)","%(/'+l+"/"+a+'/%)")')},ppx_Syncview=function(t,e,n,a,r){x.ppv.id?isEmptyStr(PPx.Extract("%N"+x.ppv.id))||(PPx.SyncView=0,PPx.Execute(_selectevent("")+"%:"+_activeevent("")),"1"===e&&PPx.Execute("*closeppx "+x.ppv.id),PPx.Execute("*setcust XV_lnum="+x.ppv.lnum+"%:*setcust XV_tmod="+x.ppv.tmod),"0"!==n&&(PPx.Execute("*setcust _WinPos:"+x.ppv.id+"="+x.ppv.winpos),"2"===n&&PPx.Execute("*setcust X_win:V="+x.ppv.xwin)),x.ppv={}):(startPPv(t,n,a,r),PPx.Execute(_selectevent("*if %*stayinfo("+i+')&&("%n"=="%%n")&&("%FDV"=="%%FDV")%%:*script ":'+i+',ppx_SelectEvent",'+r)),PPx.Execute(_activeevent('*if ("%%N%n"=="")%%:'+_selectevent("")+"%%:"+_activeevent(""))),ppx_SelectEvent(r))},ppx_SelectEvent=function(t){var e=PPx.Extract('%*name(DC,"%*comment")');if("1"===t){var n=PPx.Extract('%*name(SC,"%FSC")');"-"!==n&&(e!==PPx.Extract("%*extract("+x.ppv.id+',"%%FDC")')&&(PPx.Execute("*execute "+x.ppv.id+',%%J"'+e+'"'),waitMoment((function(){return PPx.Extract("%*extract("+x.ppv.id+',"%%FDC")')!==e}))),PPx.Execute("*execute "+x.ppv.id+",*jumpline "+n))}else PPx.Execute("*execute "+x.ppv.id+',%%J"'+e+'"')},_selectevent=function(t){return"*linecust "+c+",KC_main:SELECTEVENT,"+t},_activeevent=function(t){return"*linecust "+c+",KC_main:ACTIVEEVENT,"+t},startPPv=function(t,e,n,a){var r=PPx.Pane.Count>1,p=!isEmptyStr(t);"0"!==e&&r&&(p&&!isEmptyStr(PPx.Extract("%NV"+t))&&PPx.Execute("*closeppx V"+t),x.ppv.winpos=PPx.Extract("%*getcust(_WinPos:V"+t+")"),"2"===e&&(x.ppv.xwin=PPx.Extract("%*getcust(X_win:V)"),PPx.Execute("*setcust X_win:V=B1"+x.ppv.xwin.slice(2))));var i="";p&&(i="-bootid:"+t,i="1"===e?i+" -popup:%~N":"");var c,u="*topmostwindow %N,1";("1"!==n||isEmptyStr(x.metadata.search)||(u=u+'%:*find "'+x.metadata.search+'"'),"1"===a&&(x.ppv.lnum=PPx.Extract("%*getcust(XV_lnum)"),x.ppv.tmod=PPx.Extract("%*getcust(XV_tmod)"),PPx.Execute("*setcust XV_lnum=1%:*setcust XV_tmod=1")),x.ppv.id=PPx.Extract("%Oai *ppv "+i+" -k %("+u+'%)%%:*focus %n%:%*extract(V,"%%n")'),"2"===e&&r)&&(x.ppv.winpos=null!=(c=x.ppv.winpos)?c:PPx.Extract("%*getcust(_WinPos:"+x.ppv.id+")"),PPx.Execute("*capturewindow "+x.ppv.id+" -pane:~ -selectnoactive"))};main();
